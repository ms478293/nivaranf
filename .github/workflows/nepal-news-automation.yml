name: Nepal News Automation

on:
  schedule:
    - cron: "20 2 * * *"

permissions:
  contents: write

concurrency:
  group: nepal-news-automation
  cancel-in-progress: true

jobs:
  run-nepal-news:
    name: Run Nepal News Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTOMATION_PUSH_TOKEN || github.token }}

      - name: Ensure main branch is current
        run: |
          git checkout main
          git pull --ff-only origin main

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Validate required secrets
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "${GEMINI_API_KEY:-}" ]; then
            echo "::error::Missing required repository secret: GEMINI_API_KEY"
            exit 1
          fi

      - name: Run Nepal pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_TEXT_MODEL: ${{ vars.GEMINI_TEXT_MODEL }}
          GEMINI_IMAGE_MODEL: ${{ vars.GEMINI_IMAGE_MODEL }}
          NEPAL_NEWS_IMAGE_CANDIDATES: ${{ vars.NEPAL_NEWS_IMAGE_CANDIDATES }}
          NEPAL_NEWS_ARTICLE_ATTEMPTS: ${{ vars.NEPAL_NEWS_ARTICLE_ATTEMPTS }}
          NEPAL_NEWS_REQUIRE_PARAPHRASE: ${{ vars.NEPAL_NEWS_REQUIRE_PARAPHRASE }}
          GLOBAL_NEWS_IMAGE_CANDIDATES: ${{ vars.GLOBAL_NEWS_IMAGE_CANDIDATES }}
          GLOBAL_NEWS_ARTICLE_ATTEMPTS: ${{ vars.GLOBAL_NEWS_ARTICLE_ATTEMPTS }}
          GLOBAL_NEWS_REQUIRE_PARAPHRASE: ${{ vars.GLOBAL_NEWS_REQUIRE_PARAPHRASE }}
          GLOBAL_NEWS_DISCORD_WEBHOOK_URL: ${{ secrets.GLOBAL_NEWS_DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NIVARAN_WEBSITE_URL: ${{ vars.NIVARAN_WEBSITE_URL }}
        run: bash scripts/run_nepal_news.sh
